<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Collaborative Video Queue</title>
    <link rel="stylesheet" href="./style.css">
    <!---------------  Font Aewsome  --------------------->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" 
    integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>
<!-- search quorey and buutoons-->
<div id="searchDiv">
    <label> <input id="query" value='' autocomplete="off" type="text"/></label>
    <button id="search-button"  onclick="keyWordsearch()">Search youtube</button>   
    <button onclick="searchSpotify()">search spotify</button> 
</div>

<ul id="itemList" aria-label="Items list">
    <!-- items added by JS -->
</ul>

<div id="ytPopup" class="ytpopup">
    <button id="cancelPop">go back</button>
    <div id="container">
        <p>Search Results:</p>
        <ul id="results"></ul>
    </div>
</div>
<script>
     document.getElementById("cancelPop").addEventListener("click", () => {
        document.getElementById("ytPopup").style.display = "none";
     })
</script>
<!-- APIS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://apis.google.com/js/client.js?onload=googleApiClientReady">   </script>


<!---------------- firebase script ------------->
<script type="module">
import { 
    initializeApp 
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { 
    getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, deleteDoc, getDocs, limit, where, updateDoc
} from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyBkfk1Uc7DnKAQoHV67RPgYX77wfqov-rA",
    authDomain: "my-static-firebase-demo.firebaseapp.com",
    projectId: "my-static-firebase-demo",
    storageBucket: "my-static-firebase-demo.firebasestorage.app",
    messagingSenderId: "809904428695",
    appId: "1:809904428695:web:3a8c65f6c2f448bcaa7bd2",
    measurementId: "G-0JRKKFR4LZ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const videosCol = collection(db, "videos");
let queueDocs = [];

window.addToEnd = async function(name, videoId, platform, artist = "") {
     $('#ytPopup').css("display", "none")
  try {
    // Get the video with the highest current order value
    const q = query(videosCol, orderBy("order", "desc"), limit(1));
    const querySnapshot = await getDocs(q);

    let maxOrder = 0;
    if (!querySnapshot.empty) {
      const topDoc = querySnapshot.docs[0];
      maxOrder = topDoc.data().order || 0;
    }

    // Add the new video to Firestore
    await addDoc(videosCol, {
      platform,
      name,
      url: videoId,
      order: maxOrder + 1,
      createdAt: serverTimestamp(),
      artist: artist,
    });
  } catch (err) {
    console.error("Error adding video:", err);
  }
};

window.swapOrder = async function(orderA, orderB) {
  try {
    // Query for the two videos
    const qA = query(videosCol, where("order", "==", orderA));
    const qB = query(videosCol, where("order", "==", orderB));

    const [snapA, snapB] = await Promise.all([getDocs(qA), getDocs(qB)]);

    if (snapA.empty || snapB.empty) {
      return;
    }

    // Get document refs
    const docA = snapA.docs[0];
    const docB = snapB.docs[0];

    // Swap their order values
    await Promise.all([
      updateDoc(docA.ref, { order: orderB }),
      updateDoc(docB.ref, { order: orderA })
    ]);

    console.log(`Swapped order ${orderA} ↔ ${orderB}`);
  } catch (err) {
    console.error("Error swapping order:", err);
  }
}

window.deleteByOrder = async function(orderValue) {
  try {
    // Query for the document with this order value
    const q = query(videosCol, where("order", "==", orderValue));
    const querySnapshot = await getDocs(q);

    if (querySnapshot.empty) {
      return;
    }

    // Usually there should be only one, but handle multiple just in case
    const deletions = querySnapshot.docs.map(docSnap => deleteDoc(docSnap.ref));
    await Promise.all(deletions);

    console.log(`Deleted video(s) with order ${orderValue}`);
  } catch (err) {
    console.error("Error deleting video:", err);
  }
}


window.moveToSecondSmallest = async function(orderValue) {
  try {
    // Get all videos ordered by "order" ascending
    const q = query(videosCol, orderBy("order", "asc"));
    const snapshot = await getDocs(q);

    if (snapshot.size < 2) {
      return;
    }

    const docs = snapshot.docs;
    const secondSmallestDoc = docs[1];
    const secondSmallestOrder = secondSmallestDoc.data().order;

    // Get target document
    const targetQuery = query(videosCol, where("order", "==", orderValue));
    const targetSnap = await getDocs(targetQuery);

    if (targetSnap.empty) {
      return;
    }

    const targetDoc = targetSnap.docs[0];

    // Rule: only move if target order > secondSmallestOrder
    if (orderValue <= secondSmallestOrder) {
      return;
    }

    // Shift all orders between second smallest and target up by 1
    const updates = [];
    for (let doc of docs) {
      const docOrder = doc.data().order;
      if (docOrder >= secondSmallestOrder && docOrder < orderValue) {
        updates.push(updateDoc(doc.ref, { order: docOrder + 1 }));
      }
    }

    // Move target to second smallest
    updates.push(updateDoc(targetDoc.ref, { order: secondSmallestOrder }));

    await Promise.all(updates);

    console.log(`Moved video with order ${orderValue} → ${secondSmallestOrder}`);
  } catch (err) {
    console.error("Error moving to second smallest:", err);
  }
}

// Listen for the queue in real-time
onSnapshot(query(videosCol, orderBy("order", "asc")), (snapshot) => {
    queueDocs = snapshot.docs;
    var objects_li = [];
    queueDocs.forEach((docItem, index) => {
    const data = docItem.data();
    objects_li.push(data);
    });
    addMany(objects_li);
});

  </script>

<!--------------- youtube script --------------->
<script>
    
function keyWordsearch(){
        $('#results').append(
                    '<pre>' + "sercherd"+ '</pre>'
                    );  
        gapi.client.setApiKey('AIzaSyDFmmtvaShc4ADiWtDmQEl-UYwqH5ZiEvc');
        gapi.client.load('youtube', 'v3', function(){
                makeRequest();
        });
        $('#results').append(
                    '<pre>' + "got thru"+ '</pre>'
                    );  
}

function makeRequest(){
        var q = $('#query').val();
        $('#results').append(
                    '<pre>' + q + '</pre>'
                    );  
        var request = gapi.client.youtube.search.list({
                q: q,
                part: "snippet", 
                maxResults: 10,
                videoEmbeddable: "true",
                type: "video"
        });

        $('#results').append(
                    '<pre>' + "request" + '</pre>'
                    );  
        request.execute(function(response) {
    $('#results').empty();
    const srchItems = response.result.items;

    srchItems.forEach(item => {
    const vidTitle = $('<pre>')
      .css({
        width: '100%',
        whiteSpace: 'pre-wrap',
        wordWrap: 'break-word'
      })
      .text(item.snippet.title);

    const vidThumbimg = $('<img>')
      .attr({
        src: item.snippet.thumbnails.default.url,
        alt: 'No Image Available.'
      })
      .css({
        width: '204px',
        height: '128px'
      });

    // Create the button safely and attach a click event
    const vidButton = $('<a>')
      .attr('href', '#')
      .text('Add to Queue')
      .on('click', e => {
        e.preventDefault();
        addToEnd(item.snippet.title, item.id.videoId, 'youtube');
      });

    // Append to results container
    const container = $('<div>').css({ marginBottom: '1em' });
    container.append(vidTitle, $('<div>').append(vidThumbimg), $('<div>').append(vidButton));

    $('#results').append(container);
    $('#ytPopup').css("display", "block")
  });
});
}</script> 

<!---------------- spotify script --------------->
<script>
  
async function searchSpotify() {
  const q = $('#query').val();
  $('#results').append('<pre>' + q + '</pre>');

  try {
    const res = await fetch(`/api/spotify-search?q=${encodeURIComponent(q)}`);
    $('#results').append('<pre>' + res + '</pre>');
    const tracks = await res.json();
    $('#results').empty(); // clear previous results

    tracks.forEach(track => {
      const trackTitle = $('<pre>')
        .css({ width: '100%', whiteSpace: 'pre-wrap', wordWrap: 'break-word' })
        .text(track.name);

      const trackThumb = $('<img>')
        .attr({ src: track.image, alt: 'No Image Available.' })
        .css({ width: '64px', height: '64px' });

      const trackButton = $('<a>')
        .attr('href', '#')
        .text('Add to Queue')
        .on('click', e => {
          e.preventDefault();
          addToEnd(track.name, track.id, 'spotify', track.artist);
        });

      const container = $('<div>').css({ marginBottom: '1em' });
      container.append(trackTitle, $('<div>').append(trackThumb), $('<div>').append(trackButton));
        container.addClass("containerVid")

      $('#results').append(container);
      $('#ytPopup').css("display", "block")
    });
  } catch (err) {
    $('#results').append('<pre>Error loading Spotify results.</pre>');
  }
}

</script>

<script src="script-sortable.js"></script>
</body>
</html>
