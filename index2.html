<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Spotify + YouTube Queue Player üéß</title>
</head>
<body>
  <h1>Mixed Queue Player</h1>
  <button id="login">Login with Spotify</button>
  <input id="trackId" placeholder="Enter Spotify track ID" style="display:none;">
  <button id="play" style="display:none;">Play Song</button>
  <button id="pause" style="display:none;">Pause</button>
  <button id="idle" style="display:none;">Go Idle</button>

  <pre id="debug" style="background:#111;color:#0f0;padding:10px;white-space:pre-wrap;"></pre>

  <div id="now-playing"></div>
  <h2>Queue:</h2>
  <ul id="video-list"></ul>

  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <script type="module">
    import { 
      initializeApp 
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { 
      getFirestore, collection, query, orderBy, onSnapshot, doc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = { /* your firebase config */ };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const videosCol = collection(db, "videos");

    // Debug helper
    function debug(...args) {
      console.log(...args);
      const el = document.getElementById("debug");
      el.textContent += args.map(a => (typeof a==="object"?JSON.stringify(a,null,2):a)).join(" ") + "\n";
    }

    // --- Spotify setup ---
    const clientId = "8c55c19acece4032b9d007fdb22d88b9";
    const redirectUri = "https://jasp202-github-io.vercel.app/index2.html";
    let accessToken = null;
    let player = null;
    let currentDeviceId = null;
    let lastSpotifyTrackId = null;
    let spotifyTrackEnded = false;
    let isSpotifyPlaying = false;

    document.getElementById("login").onclick = async () => {
      const codeVerifier = generateRandomString(128);
      const codeChallenge = await sha256Challenge(codeVerifier);
      localStorage.setItem("code_verifier", codeVerifier);

      const authUrl = new URL("https://accounts.spotify.com/authorize");
      authUrl.search = new URLSearchParams({
        response_type: "code",
        client_id: clientId,
        scope: "streaming user-read-email user-read-private user-modify-playback-state user-read-playback-state",
        redirect_uri: redirectUri,
        code_challenge_method: "S256",
        code_challenge: codeChallenge,
      });
      debug("Redirecting to:", authUrl.toString());
      window.location.href = authUrl.toString();
    };

    async function handleCallback() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      if (!code) return;

      const codeVerifier = localStorage.getItem("code_verifier");
      try {
        const res = await fetch("/api/spotify-token", {
          method: "POST",
          body: new URLSearchParams({ code, redirect_uri: redirectUri, code_verifier: codeVerifier }),
        });
        const data = await res.json();
        accessToken = data.access_token;
        localStorage.setItem("access_token", accessToken);
        const me = await fetch("https://api.spotify.com/v1/me", { headers: { Authorization: `Bearer ${accessToken}` } }).then(r=>r.json());
        if(me.product !== "premium"){ debug("‚ö†Ô∏è Spotify Premium required"); return; }

        document.getElementById("login").style.display="none";
        document.getElementById("play").style.display="inline";
        document.getElementById("pause").style.display="inline";
        document.getElementById("trackId").style.display="inline";
        document.getElementById("idle").style.display="inline";
        history.replaceState({}, document.title, "/index2.html");
      } catch(err){ debug("Token exchange error:", err); }
    }
    handleCallback();

    window.onSpotifyWebPlaybackSDKReady = () => {
      const token = localStorage.getItem("access_token");
      if(!token){ debug("No access token"); return; }

      player = new Spotify.Player({
        name: "Web Player",
        getOAuthToken: cb => cb(token),
      });

      player.addListener("ready", ({device_id})=>{
        currentDeviceId=device_id;
        debug("‚úÖ Spotify ready", device_id);
      });

      player.addListener("player_state_changed", state=>{
        if(!state?.track_window?.current_track) return;
        const track=state.track_window.current_track;
        const trackId=track.id;
        const {paused, position, duration}=state;

        if(trackId!==lastSpotifyTrackId){
          lastSpotifyTrackId=trackId;
          spotifyTrackEnded=false;
          isSpotifyPlaying=true;
          debug("üéß Now playing:", track.name);
          return;
        }

        const nearEnd = position >= duration - 500;
        if(!spotifyTrackEnded && paused && nearEnd){
          spotifyTrackEnded=true;
          isSpotifyPlaying=false;
          debug("üèÅ Spotify track ended:", track.name);
          playNextFromQueue();
        }
      });

      player.connect();

      window.playSong = async (trackId)=>{
        if(!currentDeviceId){ debug("Device not ready"); return; }
        isSpotifyPlaying=true;
        spotifyTrackEnded=false;
        const uri=`spotify:track:${trackId}`;
        debug("üéµ Playing Spotify track", uri);
        await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${currentDeviceId}`,{
          method:"PUT",
          headers:{Authorization:`Bearer ${token}`, "Content-Type":"application/json"},
          body:JSON.stringify({uris:[uri]})
        });
      };

      window.pausePlayback = async ()=>{
        if(!currentDeviceId) return;
        await fetch(`https://api.spotify.com/v1/me/player/pause?device_id=${currentDeviceId}`,{method:"PUT", headers:{Authorization:`Bearer ${token}`}});
        debug("‚è∏Ô∏è Spotify paused");
      };
    };

    // --- PKCE helpers ---
    function generateRandomString(length){ const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"; let str=""; for(let i=0;i<length;i++) str+=chars.charAt(Math.floor(Math.random()*chars.length)); return str; }
    async function sha256Challenge(verifier){ const data=new TextEncoder().encode(verifier); const digest=await crypto.subtle.digest("SHA-256", data); return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); }

    // --- YouTube + Queue logic ---
    let player_yt=null;
    let currentVideoID=null;
    let queueDocs=[];

    function playVideo(url, platform){
      if(platform==="youtube"){
        const videoId=url.length===11?url:null;
        if(!player_yt){
          player_yt=new YT.Player('now-playing',{height:'360',width:'640',videoId:videoId,events:{'onStateChange':onYTStateChange}});
        }else{ player_yt.loadVideoById(videoId); }
        currentVideoID=url;
      }else if(platform==="spotify"){
        if(!isSpotifyPlaying) playSong(url);
        currentVideoID=url;
      }
    }

    function onYTStateChange(event){
      if(event.data===YT.PlayerState.ENDED) playNextFromQueue();
    }

    async function playNextFromQueue(){
      if(queueDocs.length===0) { currentVideoID=null; return; }
      await deleteDoc(doc(db,"videos",queueDocs[0].id));
    }

    onSnapshot(query(videosCol, orderBy("order","asc")), snapshot=>{
      queueDocs=snapshot.docs;
      if(queueDocs.length>0){
        const first=queueDocs[0].data();
        if(first.url!==currentVideoID){
          playVideo(first.url,first.platform);
        }
      }else{
        currentVideoID=null;
        document.getElementById("now-playing").innerHTML="<p>No videos in the queue</p>";
      }

      // render queue
      const queueList=document.getElementById("video-list");
      queueList.innerHTML="";
      queueDocs.forEach(docItem=>{
        const li=document.createElement("li");
        const data=docItem.data();
        li.textContent=data.url+", "+data.platform;
        queueList.appendChild(li);
      });
    });

    // --- Hook buttons ---
    document.getElementById("play").onclick=()=>{ const trackId=document.getElementById("trackId").value.trim()||"0pqnGHJpmpxLKifKRmU6WP"; playSong(trackId); };
    document.getElementById("pause").onclick=()=>pausePlayback();
  </script>
</body>
</html>
